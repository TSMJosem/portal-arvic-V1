/**
 * test-integration.html
 * 
 * Test de integraci√≥n completa del m√≥dulo de usuarios
 * Prueba que index.js inicialice todo correctamente
 */
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test Integraci√≥n M√≥dulo Usuarios</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #28a745;
            padding-bottom: 10px;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîå Test Integraci√≥n Completa - M√≥dulo Usuarios</h1>
        
        <div class="info result">
            <strong>üéØ Objetivo:</strong> Verificar que index.js inicialice todo correctamente<br>
            <strong>üìã Abre la consola (F12)</strong> para ver los logs de inicializaci√≥n
        </div>
        
        <div id="results"></div>
    </div>

    <!-- 1. Cargar base de datos -->
    <script src="../../databaseMongoDB.js"></script>
    
    <!-- 2. Sistema de notificaciones inline -->
    <script>
        window.NotificationUtils = {
            success: (msg) => {
                console.log('‚úÖ SUCCESS:', msg);
                addResult('‚úÖ ' + msg, 'success');
            },
            error: (msg) => {
                console.error('‚ùå ERROR:', msg);
                addResult('‚ùå ' + msg, 'error');
            },
            warning: (msg) => {
                console.warn('‚ö†Ô∏è WARNING:', msg);
                addResult('‚ö†Ô∏è ' + msg, 'info');
            },
            info: (msg) => {
                console.info('‚ÑπÔ∏è INFO:', msg);
                addResult('‚ÑπÔ∏è ' + msg, 'info');
            }
        };
    </script>
    
    <!-- 3. Cargar m√≥dulo de usuarios (index.js lo inicializar√° autom√°ticamente) -->
    <script type="module">
        const resultsDiv = document.getElementById('results');

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        // Hacer addResult global para NotificationUtils
        window.addResult = addResult;

        console.log('üß™ === TEST DE INTEGRACI√ìN ===');
        addResult('<h2>üß™ Iniciando test de integraci√≥n...</h2>', 'info');

        // Importar index.js (se auto-inicializar√°)
        import('./index.js').then(() => {
            console.log('üì¶ index.js importado');
            
            // Esperar a que se auto-inicialice
            setTimeout(async () => {
                console.log('üîç Verificando inicializaci√≥n...');
                
                // Test 1: Verificar que window.userModule existe
                addResult('<h3>Test 1: Verificar window.userModule</h3>', 'info');
                if (window.userModule) {
                    addResult('‚úÖ window.userModule existe', 'success');
                } else {
                    addResult('‚ùå window.userModule NO existe', 'error');
                    return;
                }

                // Test 2: Verificar m√©todos disponibles
                addResult('<h3>Test 2: Verificar m√©todos p√∫blicos</h3>', 'info');
                const requiredMethods = ['editUser', 'deleteUser', 'closeEditModal'];
                let allMethodsExist = true;
                
                requiredMethods.forEach(method => {
                    if (typeof window.userModule[method] === 'function') {
                        addResult(`‚úÖ M√©todo ${method}() disponible`, 'success');
                    } else {
                        addResult(`‚ùå M√©todo ${method}() NO disponible`, 'error');
                        allMethodsExist = false;
                    }
                });

                // Test 3: Verificar acceso a instancias
                addResult('<h3>Test 3: Verificar acceso a instancias</h3>', 'info');
                const requiredInstances = ['service', 'repository', 'validator', 'modal'];
                let allInstancesExist = true;
                
                requiredInstances.forEach(instance => {
                    if (window.userModule[instance]) {
                        addResult(`‚úÖ Instancia ${instance} disponible`, 'success');
                    } else {
                        addResult(`‚ùå Instancia ${instance} NO disponible`, 'error');
                        allInstancesExist = false;
                    }
                });

                // Test 4: Autenticarse y probar obtener usuarios
                addResult('<h3>Test 4: Probar funcionalidad b√°sica</h3>', 'info');
                try {
                    const loginResult = await window.PortalDB.validateUser('admin', 'hperez1402.');
                    
                    if (loginResult.success) {
                        addResult('‚úÖ Autenticaci√≥n exitosa', 'success');
                        
                        // Probar obtener usuarios usando el servicio
                        const users = await window.userModule.service.getAll();
                        addResult(`‚úÖ Usuarios obtenidos: ${Object.keys(users).length}`, 'success');
                        
                        // Probar generar contrase√±a
                        const password = await window.userModule.service.generatePassword();
                        addResult(`‚úÖ Contrase√±a generada: <code>${password}</code>`, 'success');
                        
                    } else {
                        addResult('‚ùå Error de autenticaci√≥n', 'error');
                    }
                } catch (error) {
                    addResult(`‚ùå Error en test funcional: ${error.message}`, 'error');
                }

                // Test 5: Verificar que editUser() es callable
                addResult('<h3>Test 5: Verificar que editUser() es invocable</h3>', 'info');
                addResult(
                    '‚úÖ M√©todo <code>window.userModule.editUser(userId)</code> listo para usar en admin.js',
                    'success'
                );

                // Resumen final
                addResult('<h2>üéâ TESTS COMPLETADOS</h2>', 'success');
                addResult(
                    '<strong>‚úÖ Resumen:</strong><br>' +
                    '‚Ä¢ window.userModule inicializado correctamente<br>' +
                    '‚Ä¢ Todos los m√©todos p√∫blicos disponibles<br>' +
                    '‚Ä¢ Todas las instancias accesibles<br>' +
                    '‚Ä¢ Funcionalidad b√°sica verificada<br>' +
                    '<br>' +
                    '<strong>üéØ Pr√≥ximo paso:</strong><br>' +
                    'Modificar admin.js para usar window.userModule.editUser() y window.userModule.deleteUser()',
                    'success'
                );

                console.log('üéâ === TESTS COMPLETADOS ===');

            }, 500); // Esperar 500ms para que se complete la auto-inicializaci√≥n
        }).catch(error => {
            console.error('‚ùå Error importando index.js:', error);
            addResult(`‚ùå Error importando m√≥dulo: ${error.message}`, 'error');
        });
    </script>
</body>
</html>